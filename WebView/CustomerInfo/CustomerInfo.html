<!DOCTYPE html>
<html>
	<head>
        <title>Customer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <!-- Plotly.js -->
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <!-- Jquery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <!--fonts-->
        <!--<link href='http://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>-->
        <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans" />
        <!--CSS-->
        <style type="text/css">

            input {
                /* text-align: center; */
                color: #222 !important;
                background-color: rgba(0,0,0,0) !important;
                border-color: rgba(0,0,0,0) !important;
                font-size: 14px !important;
                margin-top: -10px !important;
            }
            table, th, td {
                text-align: center;
            }    
            html {
              font-size: 12px;
            }
            body { 
                font-family: 'Open Sans' !important;
                color: #222;
            }
            h2,h4{ 
               /* font-family: 'inherit'  !important;*/ 
                margin-left: 10px;
                color: #000 !important;
                border-bottom: 1px solid #cfcfcf;
                /*border-top: 1px solid #dcdcdc;
                /*background:#f5f5f5;*/
            }
            label{
                color: #a5a5a5;
                margin-left: 10px;
                font-size: 12px !important;
            } 

        </style>
	</head>

	<body>
    	<div class="container-fluid">
            <h2>Snapshot de Cliente</h2>
            <div class="row" id="section1">
                <div class="col" id="lefttside">
                    <div class="row justify-content-center" id="plot"><!-- Plotly chart will be drawn inside this DIV --></div>
                </div>
                <div class="col align-self-center" id="righttside">
                    <h4>Cr&eacute;dito</h4>
                    <div class="row justify-content-between">
                        <div class="col-lg-6">
                            <label for="creditor">Viable para cr&eacute;dito</label>
                            <input type="text" id="creditor" class="form-control" aria-describedby="basic-addon3" disabled="">
     
                            <label for="amount_seg">Linea de cr&eacute;dito de segment</label>
                            <input type="text" id="amount_seg" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>
                        <div class="col-lg-6">
                            <label for="creditor_prob">Nivel de Confianza</label>
                            <input type="text" id="creditor_prob" class="form-control" aria-describedby="basic-addon3" disabled>
   
                            <label for="amount_predict">Linea de cr&eacute;dito<br>Individual</label>
                            <input type="text" id="amount_predict" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>        
                    </div>
                    <br>
                    <h4>RFM</h4>
                    <div class="row">
                        <div class="col-md-3"> 
                            <label for="R">R</label>
                            <input type="text" id="R" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>    
                        <div class="col-md-3"> 
                            <label for="F">F</label>
                            <input type="text" id="F" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>    
                        <div class="col-md-3"> 
                            <label for="M">M</label>
                            <input type="text" id="M" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>  
                        <div class="col-md-3"> 
                            <label for="segment">Segmento</label>
                            <input type="text" id="segment" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>    
                    </div>
                    <br>
                    <h4>CLV</h4>
                    <div class="row">
                        <div class="col-lg-4">
                            <label for="lifetime">Tiempo de Vida<br>Promedio de Cliente (Meses)</label>
                            <input type="text" id="lifetime" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>
                        <div class="col-lg-4">   
                            <label for="cv">Valor de Cliente</label>
                            <input type="text" id="cv" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>
                        <div class="col-lg-4">  
                            <label for="clv">Customer lifetime Value</label>
                            <input type="text" id="clv" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>
                    </div>
                </div>
            </div>
            <br>
            <div class="row" id="section2">  
                <div class="col">
                    <h4>NBO</h4>
                    <div class="row">  
                        <div class="col-6" >
                            <label for="Product_predict">Producto Recomendado</label>
                            <input type="text" id="Product_predict" class="form-control" aria-describedby="basic-addon3" disabled>
                        </div>
                    </div>
                    <br>
                    <div>                  
                        <table id='productos' class="table">
                            <thread>
                                <tr>
                                    <th scope="col">#</th> 
                                    <th scope="col">Producto</th>
                                    <th scope="col">Nivel de Confianza</th>
                                </tr>
                            </thread>
                            <tbody>
                                <tr></tr>
                            </tbody>    
                        </table>                     
                    </div>
                </div>
                <div class="col">
                    <h4>Historial de llamadas</h4>
                    <br>
                    <div>
                        <table id='calls' class="table">
                            <thread>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Llamada</th>
                                    <th scope="col">Fecha</th>
                                    <th scope="col">Estado</th>
                                    <th scope="col">Venta</th>
                                    <th scope="col">Producto</th>
                                </tr>
                            </thread>
                            <tbody>
                                <tr></tr>
                            </tbody>    
                        </table>
                    </div>
                </div>
            </div>
 		</div>	
        <script>
			var id=getGetVariable("id");
			//var id="377a50ed-a657-db1c-c858-591b269b1e6c";
			var url='http://'+window.location.host+'/CustomerInfo/getCustomerInfo.php?id='+id;
			//var post={"id":id,};
            //var productos_list={'1':'Leasing','2':'credit Simple','3':'credit Automotriz','4':'Factoraje','5':'Linea credit simple'};

			$.ajax({
			  type: "GET",
			  url: url,
			  //data: post,
			  dataType:'json',
			  success:function(data){

                console.log(data);
				createplot(data);
            	fillfields(data);

			  },
              error:function(error){
                console.log(error.responseText);
			  },
			});

			function getGetVariable(variable){
				       var query = window.location.search.substring(1);
				       var vars = query.split("&");
				       for (var i=0;i<vars.length;i++) {
				               var pair = vars[i].split("=");
				               if(pair[0] == variable){
				               	return pair[1];
				               }
				       }
				       return(false);
			}

			function createplot(client_info){

				var clv=parseFloat(client_info.clv.clv_n);
				var cv=parseFloat(client_info.clv.cv_n);
				var R=parseFloat(client_info.rfm.r_n);
				var F=parseFloat(client_info.rfm.f_n);
				var M=parseFloat(client_info.rfm.m_n);

				data = [
				  {
				  type: 'scatterpolar',
                  theta: ['clv', 'Client Value','Recencia','Frecuencia','Monto','clv'],
				  r: [clv, cv, R, F, M,clv],
				  name: 'Group B',
				  hoverinfo: 'theta',
                  fill: 'toself',
                  fillcolor: '#rgba(22, 108, 227, 0.54)',
                  line : {color : '#166ce3'}       
				  }
				]
				layout = {
				  polar: {
				    radialaxis: {
				      visible: false,
				      range: [0, 1],
                      color: '#166ce3' //color de los ejes radiales
				    },
                    bgcolor: 'rgba(0,0,0,0)' //color del grafico
                  },
                  paper_bgcolor: 'rgba(0,0,0,0)', //color del layout
                  //font: {size:'20',color: '21ef8b'}
                  font: {family: "'Open Sans'"},
                  autosize:false,
                  width:400,
                  height:400,
                  margin:{
                        l:75,
                        r:75,
                        b:0,
                        t:0,
                        pad:0
                    }
                }

				Plotly.plot("plot", data, layout,{responsive: true})	
            }

            function convertUTCDateToLocalDate(date) {
                var newDate = new Date(date.getTime()-date.getTimezoneOffset()*60*1000);

                var offset = date.getTimezoneOffset() / 60;
                var hours = date.getHours();

                newDate.setHours(hours - offset);

                return newDate;   
            }

			function fillfields(client_info){
                var cv=parseFloat(parseFloat(client_info.clv.cv).toFixed(2)).toLocaleString('en');
                cv=(cv.indexOf(".")==-1)? cv+='.00':cv;
                var clv=parseFloat(parseFloat(client_info.clv.clv).toFixed(2)).toLocaleString('en');
                clv=(clv.indexOf(".")==-1)? clv+='.00':clv;
                var amount_seg=parseFloat(parseFloat(client_info.credit.amount_seg).toFixed(2)).toLocaleString('en');
                amount_seg=(amount_seg.indexOf(".")==-1)? amount_seg+='.00':amount_seg;
                var amount_predict=parseFloat(parseFloat(client_info.credit.amount_predict).toFixed(2)).toLocaleString('en');
                amount_predict=(amount_predict.indexOf(".")==-1)? amount_predict+='.00':amount_predict;

                $('#creditor').val(client_info.credit.creditor);
                $('#creditor_prob').val(client_info.credit.creditor_prob+'%');
                $('#amount_seg').val('$ '+amount_seg);
                $('#amount_predict').val('$ '+amount_predict);
                if(client_info.credit.creditor=='No'){
                    $('#creditlineind').hide();
                    $('#creditlineseg').hide();
                }
				$('#R').val(client_info.rfm.r);
                $('#F').val(client_info.rfm.f);
                $('#M').val(client_info.rfm.m);
                $('#segment').val(client_info.rfm.segment);
                $('#lifetime').val(parseFloat(client_info.clv.lifeTime).toFixed(2));
                $('#cv').val('$ '+cv);
                $('#clv').val('$ '+clv);
                $('#Product_predict').val(client_info.nbo.item_predict);

                var productos=Object.keys(client_info.nbo);
                var numproductos=productos.length-1;
                for (var i = 0; i < numproductos; i++) {
                    var temp=parseFloat(client_info.nbo[productos[i]]);

                    $('#productos tr:last').after('<tr><th scope="row">'+(i+1)+'</th><td class="tipo_producto">'+productos[i]+'</td><td>'+temp.toFixed(2)+'%</td></tr>');
                }

                var numcalls_predict=Object.keys(client_info.calls.predict).length;
                for (var i = 0; i < numcalls_predict; i++) {
                    //var temp=parseFloat(client_info.nbo['Producto_'+i]);
                    $('#calls tr:last').after('<tr class="call_predict"><th scope="row">'+(i+1)+'</th><td>'+client_info.calls.predict[i].name+'</td><td><p class="date_call">'+client_info.calls.predict[i].date_end+'</p></td><td><p class="status_call">'+client_info.calls.predict[i].status+'</p></td><td class="venta_call">'+client_info.calls.predict[i].sale+'</td><td>-</td></tr>');
                }

                var numcalls_crm=Object.keys(client_info.calls.crm).length;
                for (var i = 0; i < numcalls_crm; i++) {
                    //var temp=parseFloat(client_info.nbo['Producto_'+i]);
                    $('#calls tr:last').after('<tr><th scope="row">'+(i+numcalls_predict+1)+'</th><td><a href="http://'+window.location.host+'/unifin/#calls/'+client_info.calls.crm[i].id_call+'" target="_parent">'+client_info.calls.crm[i].name+'</a></td><td><p class="date_call">'+client_info.calls.crm[i].date_end+'</p></td><td><p class="status_call">'+client_info.calls.crm[i].status+'</p></td><td class="venta_call">'+client_info.calls.crm[i].sale+'</td><td class="producto_sold"><b>'+client_info.calls.crm[i].item_sold+'</b></td></tr>');
                }

                $('.venta_call').each(function(){
                    if($(this).text()==0){
                        //$(this).empty()
                        $(this).text('-')
                        //$(this).append('<img src="check.png">')
                    }else if($(this).text()==1){
                        $(this).empty()
                        $(this).append('<img src="check.png">')
                    }    
                });

                $('.status_call').each(function(){
                    if($(this).text()=='Held'){
                        $(this).text('Realizada');
                        $(this).css({"background-color":"#54cb14","color":"#fff","font-weight":"600" });
                    }else if($(this).text()=='Planned'){
                        $(this).text('Planificada');
                        $(this).css({"border": "1px solid #555"});
                    }   
                });

                Number.prototype.padLeft = function(base,chr){
                    var  len = (String(base || 10).length - String(this).length)+1;
                    return len > 0? new Array(len).join(chr || '0')+this : this;
                }

                $('.date_call').each(function(){
                    var d = new Date($(this).text());
                    var today=new Date();
                        d=convertUTCDateToLocalDate(d);
                        dformat = [(d.getMonth()+1).padLeft(),
                                   d.getDate().padLeft(),
                                   d.getFullYear()].join('/') +' ' +
                                  [d.getHours().padLeft(),
                                   d.getMinutes().padLeft(),
                                   d.getSeconds().padLeft()].join(':');
                    /*if(d<Date.now()){
                        $(this).css({"background-color":"#e61718","color":"#fff"});
                    }*/
                    if (((today.getMonth()+1)<(d.getMonth()+1)) && ($(this).parent().parent().attr('class')=='call_predict') ) {
                        $(this).parent().parent().hide()
                    }
                    $(this).text(dformat);
                })
    		}

		</script>
	</body>
</html>


